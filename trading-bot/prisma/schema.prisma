generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Candle {
  id         BigInt   @id @default(autoincrement())
  symbol     String
  timeframe  String
  openTime   DateTime
  closeTime  DateTime
  open       Decimal  @db.Decimal(20, 10)
  high       Decimal  @db.Decimal(20, 10)
  low        Decimal  @db.Decimal(20, 10)
  close      Decimal  @db.Decimal(20, 10)
  volume     Decimal  @db.Decimal(30, 10)
  createdAt  DateTime @default(now())

  rawPayload Json?

  @@unique([symbol, timeframe, closeTime], name: "symbol_timeframe_closeTime")
  @@index([symbol, timeframe, openTime])
  @@map("candles")
}

model Feature {
  id           BigInt   @id @default(autoincrement())
  symbol       String
  timeframe    String
  computedAt   DateTime
  payload      Json
  paramVersion String
  createdAt    DateTime @default(now())

  @@unique([symbol, timeframe, computedAt], name: "symbol_timeframe_computedAt")
  @@index([symbol, timeframe, computedAt])
  @@map("features")
}

model Signal {
  id           BigInt   @id @default(autoincrement())
  symbol       String
  side         String
  strength     Decimal  @db.Decimal(10, 6)
  generatedAt  DateTime
  rationale    Json?
  paramVersion String
  createdAt    DateTime @default(now())

  @@index([symbol, generatedAt])
  @@map("signals")
}

model Order {
  id            BigInt   @id @default(autoincrement())
  exchange      String
  externalId    String?  @unique
  symbol        String
  side          String
  orderType     String
  status        String
  quantity      Decimal  @db.Decimal(20, 10)
  price         Decimal? @db.Decimal(20, 10)
  submittedAt   DateTime
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  fills         Fill[]

  @@index([symbol, submittedAt])
  @@map("orders")
}

model Fill {
  id         BigInt   @id @default(autoincrement())
  orderId     BigInt
  price      Decimal  @db.Decimal(20, 10)
  quantity   Decimal  @db.Decimal(20, 10)
  fee        Decimal? @db.Decimal(20, 10)
  feeAsset   String?
  filledAt   DateTime
  createdAt  DateTime @default(now())

  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, filledAt])
  @@map("fills")
}

model Position {
  id           BigInt   @id @default(autoincrement())
  symbol       String
  side         String
  quantity     Decimal  @db.Decimal(20, 10)
  avgEntry     Decimal  @db.Decimal(20, 10)
  unrealizedPnL Decimal @db.Decimal(20, 10) @default(0)
  openedAt     DateTime
  closedAt     DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([symbol, openedAt])
  @@map("positions")
}

model AuditEvent {
  id         BigInt   @id @default(autoincrement())
  category   String
  action     String
  actor      String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([category, createdAt])
  @@map("audit_events")
}

model ParamVersion {
  id          BigInt   @id @default(autoincrement())
  name        String
  version     String
  config      Json
  activatedAt DateTime
  createdAt   DateTime @default(now())

  @@unique([name, version])
  @@map("param_versions")
}
